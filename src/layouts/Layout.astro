---
import { ViewTransitions } from "astro:transitions";
import Navigation from "../components/Navigation.astro";
import Footer from "../components/Footer.astro";
import BackToTop from "../components/BackToTop.astro";
import ImageModal from "../components/ImageModal.astro";
import i18next from "i18next";

interface Props {
    title?: string;
    description?: string;
    canonicalUrl?: string;
    noindex?: boolean;
}

const {
    title = "Solar Fusion",
    description = "Solar Fusion - Vodeći dobavljač solarnih energetskih rješenja. Instalacija solarnih panela, baterija i pretvarača za vaš dom ili poslovanje.",
    canonicalUrl,
    noindex = false,
} = Astro.props;

const { lang = "hr" } = Astro.params;
const baseUrl = "https://solarfusion.hr"; // Update this with your actual domain
const currentPath = Astro.url.pathname;
const canonical = canonicalUrl || `${baseUrl}${currentPath}`;

// Construct the full title with the site name
const fullTitle = title.includes("Solar Fusion")
    ? title
    : `Solar Fusion | ${title}`;

// Define critical resources
const criticalImageUrl =
    "https://images.unsplash.com/photo-1509391366360-2e959784a276?q=80&w=2000&auto=format&fit=crop";
const mobileImageUrl =
    "https://images.unsplash.com/photo-1509391366360-2e959784a276?q=80&w=1024&auto=format&fit=crop";
---

<!doctype html>
<html lang={lang}>
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
        <meta name="generator" content={Astro.generator} />

        <!-- SEO Meta Tags -->
        <title>{fullTitle}</title>
        <meta name="description" content={description} />
        <link rel="canonical" href={canonical} />
        {noindex && <meta name="robots" content="noindex,nofollow" />}
        <meta name="author" content="Solar Fusion" />
        <meta
            name="keywords"
            content="solar panels, solar energy, solar installation, renewable energy, solar power, Croatia, energy savings, sustainable energy"
        />

        <!-- Open Graph / Facebook Meta Tags -->
        <meta property="og:type" content="website" />
        <meta property="og:url" content={canonical} />
        <meta property="og:title" content={fullTitle} />
        <meta property="og:description" content={description} />
        <meta property="og:image" content={criticalImageUrl} />
        <meta property="og:locale" content={lang} />
        <meta property="og:site_name" content="Solar Fusion" />

        <!-- Twitter Meta Tags -->
        <meta name="twitter:card" content="summary_large_image" />
        <meta name="twitter:url" content={canonical} />
        <meta name="twitter:title" content={fullTitle} />
        <meta name="twitter:description" content={description} />
        <meta name="twitter:image" content={criticalImageUrl} />

        <!-- Resource hints for faster resource loading -->
        <link rel="dns-prefetch" href="https://assets.cdn.filesafe.space" />
        <link rel="dns-prefetch" href="https://images.unsplash.com" />
        <link
            rel="preconnect"
            href="https://assets.cdn.filesafe.space"
            crossorigin
        />
        <link rel="preconnect" href="https://images.unsplash.com" crossorigin />
        <link
            rel="preconnect"
            href="https://fonts.googleapis.com"
            crossorigin
        />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

        <!-- Mobile-specific preload for critical LCP image -->
        <link
            rel="preload"
            as="image"
            href={mobileImageUrl}
            media="(max-width: 768px)"
            fetchpriority="high"
        />
        <link
            rel="preload"
            as="image"
            href={criticalImageUrl}
            media="(min-width: 769px)"
            fetchpriority="high"
        />

        <!-- Structured Data - Local Business -->
        <script type="application/ld+json">
            {
                "@context": "https://schema.org",
                "@type": "LocalBusiness",
                "name": "Solar Fusion",
                "image": "https://images.unsplash.com/photo-1509391366360-2e959784a276?q=80&w=2000&auto=format&fit=crop",
                "description": "Solar Fusion - Vodeći dobavljač solarnih energetskih rješenja. Instalacija solarnih panela, baterija i pretvarača za vaš dom ili poslovanje.",
                "address": {
                    "@type": "PostalAddress",
                    "streetAddress": "Istarska ulica 23",
                    "addressLocality": "Zagreb",
                    "addressRegion": "Zagreb",
                    "postalCode": "10000",
                    "addressCountry": "HR"
                },
                "telephone": "+385 1 234 5678",
                "email": "info@solarfusion.hr",
                "url": "https://solarfusion.hr",
                "openingHours": "Mo,Tu,We,Th,Fr 09:00-17:00",
                "priceRange": "$$",
                "sameAs": [
                    "https://www.facebook.com/solarfusion",
                    "https://www.instagram.com/solarfusion",
                    "https://www.linkedin.com/company/solarfusion"
                ],
                "serviceArea": {
                    "@type": "GeoCircle",
                    "geoMidpoint": {
                        "@type": "GeoCoordinates",
                        "latitude": "45.815399",
                        "longitude": "15.966568"
                    },
                    "geoRadius": "100000"
                }
            }
        </script>

        <!-- Structured Data - Website -->
        <script type="application/ld+json">
            {
                "@context": "https://schema.org",
                "@type": "WebSite",
                "name": "Solar Fusion",
                "url": "https://solarfusion.hr",
                "potentialAction": {
                    "@type": "SearchAction",
                    "target": "https://solarfusion.hr/search?q={search_term_string}",
                    "query-input": "required name=search_term_string"
                }
            }
        </script>

        <!-- Structured Data - Service -->
        <script type="application/ld+json">
            {
                "@context": "https://schema.org",
                "@type": "Service",
                "serviceType": "Solar Panel Installation",
                "provider": {
                    "@type": "LocalBusiness",
                    "name": "Solar Fusion"
                },
                "areaServed": {
                    "@type": "Country",
                    "name": "Croatia"
                },
                "description": "Professional installation of solar panels for residential and commercial buildings, offering energy independence and cost savings.",
                "offers": {
                    "@type": "Offer",
                    "priceSpecification": {
                        "@type": "PriceSpecification",
                        "priceCurrency": "EUR"
                    }
                }
            }
        </script>

        <!-- Structured Data - FAQ -->
        <script type="application/ld+json">
            {
                "@context": "https://schema.org",
                "@type": "FAQPage",
                "mainEntity": [
                    {
                        "@type": "Question",
                        "name": "How much can I save with solar panels?",
                        "acceptedAnswer": {
                            "@type": "Answer",
                            "text": "Most customers save up to 90% on their electricity bills after installing solar panels. The exact savings depend on your energy consumption, roof orientation, and local solar conditions."
                        }
                    },
                    {
                        "@type": "Question",
                        "name": "How long does a solar panel installation take?",
                        "acceptedAnswer": {
                            "@type": "Answer",
                            "text": "A typical residential installation takes 1-3 days, while commercial installations may take 1-2 weeks depending on the system size."
                        }
                    },
                    {
                        "@type": "Question",
                        "name": "Are there any government incentives available?",
                        "acceptedAnswer": {
                            "@type": "Answer",
                            "text": "Yes, there are various incentives available in Croatia including tax rebates and subsidies. Our consultants will help you navigate available options during your free consultation."
                        }
                    }
                ]
            }
        </script>

        <!-- Critical rendering path optimization -->
        <script is:inline define:vars={{ mobileImageUrl, criticalImageUrl }}>
            // Mobile detection
            const isMobile =
                /iPhone|iPad|iPod|Android/i.test(navigator.userAgent) ||
                window.innerWidth <= 768;

            // Immediately set a base dark background color to avoid flash
            document.documentElement.style.backgroundColor = "#1a202c";

            // Critical font preloading for the hero subtitle
            const fontLink = document.createElement("link");
            fontLink.rel = "preload";
            fontLink.href =
                "https://fonts.googleapis.com/css2?family=Inter:wght@700&display=swap";
            fontLink.as = "style";
            document.head.appendChild(fontLink);

            // LCP optimization - initiate early fetch for critical image
            if (isMobile) {
                const preloadLink = document.createElement("link");
                preloadLink.rel = "preload";
                preloadLink.as = "image";
                preloadLink.href = `${mobileImageUrl}`;
                preloadLink.fetchPriority = "high";
                document.head.appendChild(preloadLink);
            }

            // Prevent layout shifts by setting initial dimensions
            document.documentElement.style.setProperty(
                "--hero-height",
                "100vh"
            );

            // Set content-visibility auto for below-the-fold content on mobile
            if (isMobile) {
                document.addEventListener("DOMContentLoaded", () => {
                    const belowFoldElements = document.querySelectorAll(
                        "section:not(.hero-section)"
                    );
                    belowFoldElements.forEach((el, index) => {
                        if (index > 0) {
                            // Skip the first section after hero
                            el.style.contentVisibility = "auto";
                            el.style.containIntrinsicSize = "0 500px"; // Estimated size
                        }
                    });
                });
            }
        </script>

        <!-- Inline critical CSS for mobile -->
        <style is:inline>
            /* Mobile-specific optimizations */
            @media (max-width: 768px) {
                /* Optimize font rendering for mobile */
                body {
                    text-rendering: optimizeSpeed;
                    -webkit-font-smoothing: antialiased;
                }

                /* Reduce animation complexity on mobile */
                * {
                    transition-duration: 0.1s !important;
                    animation-duration: 0.1s !important;
                }

                /* Improve touch response */
                a,
                button {
                    touch-action: manipulation;
                }
            }
        </style>

        <!-- Add View Transitions - simplified -->
        <ViewTransitions />

        <!-- Simplified preconnect setup -->
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            rel="preconnect"
            href="https://assets.cdn.filesafe.space"
            crossorigin
        />

        <!-- Preload only critical resources -->
        <link
            rel="preload"
            href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
            as="style"
            onload="this.onload=null;this.rel='stylesheet'"
        />

        <!-- Fallback for no-JS -->
        <noscript>
            <link
                href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
                rel="stylesheet"
                type="text/css"
            />
        </noscript>

        <!-- Simplified critical CSS -->
        <style is:inline>
            /* Core styles only */
            @font-face {
                font-family: "Inter";
                font-style: normal;
                font-weight: 400;
                font-display: swap;
                src: local("Inter Regular"), local("Inter-Regular");
            }

            :root {
                --primary-color: #0f172a;
                --secondary-color: #f59e0b;
                --text-color: #1f2937;
                --text-light: #e5e7eb;
                --hero-font-size: 3.75rem;
            }

            html,
            body {
                margin: 0;
                padding: 0;
                width: 100%;
                overflow-x: hidden;
                font-family:
                    "Inter",
                    system-ui,
                    -apple-system,
                    sans-serif;
                font-size: 16px;
                line-height: 1.5;
                color: var(--text-color);
                background-color: #f9fafb;
            }

            /* Mobile optimizations */
            .is-mobile {
                font-size: 14px;
            }

            /* Optimize images */
            img {
                max-width: 100%;
                height: auto;
            }

            /* Optimize hero content */
            .hero-title,
            .hero-subtitle {
                font-size: var(--hero-font-size);
            }

            /* Reduce layout shifts */
            [data-astro-cid] {
                contain: layout;
            }

            /* Basic modal styles */
            .modal {
                display: none;
                position: fixed;
                z-index: 100;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
            }
        </style>
    </head>
    <body>
        <Navigation />
        <slot />
        <Footer />
        <BackToTop />
        <ImageModal />

        <!-- Deferred script loading -->
        <script>
            // Add any non-critical scripts here
            document.addEventListener("DOMContentLoaded", function () {
                // Initialize components after page is fully loaded
                // @ts-ignore - Allow access to the global function
                if (typeof window.initializeModals === "function") {
                    // @ts-ignore
                    window.initializeModals();
                }
            });
        </script>

        <!-- Simplified modal handling script -->
        <script is:inline>
            // Define the global modal function
            window.initializeModals = function () {
                // Mobile-optimized modal initialization
                const isMobile =
                    document.documentElement.classList.contains("is-mobile");

                // Simple modal handling with fewer animations for mobile
                document.querySelectorAll(".modal").forEach((modal) => {
                    const modalId = modal.id;

                    // Handle modal opening
                    document
                        .querySelectorAll(`[data-open-modal="${modalId}"]`)
                        .forEach((trigger) => {
                            trigger.addEventListener("click", (e) => {
                                e.preventDefault();

                                // Simple display without animations for mobile
                                modal.style.display = "block";
                                document.body.style.overflow = "hidden";

                                // Add visible class (for desktop animations)
                                if (!isMobile) {
                                    setTimeout(
                                        () =>
                                            modal.classList.add(
                                                "modal-visible"
                                            ),
                                        10
                                    );
                                } else {
                                    modal.classList.add("modal-visible");
                                }
                            });
                        });

                    // Handle modal closing
                    const closeModal = () => {
                        if (!isMobile) {
                            modal.classList.remove("modal-visible");
                            setTimeout(() => {
                                modal.style.display = "none";
                                document.body.style.overflow = "";
                            }, 200);
                        } else {
                            modal.classList.remove("modal-visible");
                            modal.style.display = "none";
                            document.body.style.overflow = "";
                        }
                    };

                    // Close on button click
                    modal
                        .querySelectorAll("[data-close-modal]")
                        .forEach((btn) => {
                            btn.addEventListener("click", closeModal);
                        });

                    // Close on backdrop click if it exists
                    const backdrop = modal.querySelector(".modal-backdrop");
                    if (backdrop) {
                        backdrop.addEventListener("click", (e) => {
                            if (e.target === backdrop) closeModal();
                        });
                    }

                    // Close on ESC key
                    document.addEventListener("keydown", (e) => {
                        if (
                            e.key === "Escape" &&
                            modal.style.display === "block"
                        ) {
                            closeModal();
                        }
                    });
                });
            };

            // Initialize on page load for non-Astro use cases
            document.addEventListener(
                "DOMContentLoaded",
                window.initializeModals
            );

            // Initialize after Astro page transitions
            document.addEventListener(
                "astro:page-load",
                window.initializeModals
            );
        </script>

        <!-- Google Analytics -->
        <script
            async
            src="https://www.googletagmanager.com/gtag/js?id=G-MEASUREMENT_ID"
        ></script>
        <script is:inline>
            // Google Analytics setup
            window.dataLayer = window.dataLayer || [];
            function gtag() {
                window.dataLayer.push(arguments);
            }
            gtag("js", new Date());
            gtag("config", "G-MEASUREMENT_ID");
        </script>

        <!-- Cookie Consent Setup -->
        <script is:inline>
            window.addEventListener("load", function () {
                // Check if user has previously consented to cookies
                const hasConsent = localStorage.getItem("cookie-consent");

                if (!hasConsent) {
                    // Show cookie consent banner (which already exists in your CookieConsent component)
                    const cookieBanner =
                        document.querySelector("#cookie-banner");
                    if (cookieBanner) cookieBanner.classList.remove("hidden");
                } else if (hasConsent === "accepted") {
                    // If user has already accepted, initialize analytics
                    initializeAnalytics();
                }
            });

            function initializeAnalytics() {
                // Enable analytics tracking - this would be called when user accepts cookies
                if (typeof gtag === "function") {
                    gtag("consent", "update", {
                        analytics_storage: "granted",
                    });
                }
            }

            // Function to be called when user accepts cookies
            window.acceptCookies = function () {
                localStorage.setItem("cookie-consent", "accepted");
                initializeAnalytics();
                const cookieBanner = document.querySelector("#cookie-banner");
                if (cookieBanner) cookieBanner.classList.add("hidden");
            };

            // Function to be called when user rejects cookies
            window.rejectCookies = function () {
                localStorage.setItem("cookie-consent", "rejected");
                if (typeof gtag === "function") {
                    gtag("consent", "update", {
                        analytics_storage: "denied",
                    });
                }
                const cookieBanner = document.querySelector("#cookie-banner");
                if (cookieBanner) cookieBanner.classList.add("hidden");
            };
        </script>
    </body>
</html>
